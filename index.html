<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>AR no papel — MindAR (compat)</title>

  <!-- Versões não-módulo, mais compatíveis com iOS -->
  <script src="https://unpkg.com/mind-ar/dist/mindar-image.prod.js"></script>
  <script src="https://unpkg.com/three/build/three.min.js"></script>
  <script src="https://unpkg.com/three/examples/js/loaders/GLTFLoader.js"></script>

  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui}
    .hud{position:fixed;inset:auto 0 0 0;display:flex;gap:8px;padding:10px;justify-content:center;background:linear-gradient(to top, rgba(0,0,0,.55), transparent)}
    .btn{appearance:none;border:1px solid #fff;border-radius:10px;background:rgba(255,255,255,.08);color:#fff;padding:10px 12px;font-size:14px}
    .btn:active{transform:translateY(1px)}
    .info{position:fixed;left:10px;top:10px;color:#fff;font-size:13px;background:rgba(0,0,0,.5);padding:6px 8px;border-radius:8px;max-width:75ch}
    .center{position:fixed;inset:0;display:grid;place-items:center}
    .start{padding:12px 16px;font-size:16px}
  </style>
</head>
<body>
  <div class="info" id="info">Carregando...</div>
  <div class="center" id="gate">
    <button class="btn start" id="startBtn">Iniciar AR</button>
  </div>
  <div class="hud">
    <button id="bScaleDown" class="btn">Escala −10%</button>
    <button id="bScaleUp" class="btn">Escala +10%</button>
    <button id="bYDown" class="btn">Altura −1 cm</button>
    <button id="bYUp" class="btn">Altura +1 cm</button>
    <button id="bGrid" class="btn">Grade 10 cm</button>
  </div>

  <script>
    // Mostra erros na tela (senão no iPhone vira silêncio)
    window.addEventListener('error', e=>{
      const el = document.getElementById('info');
      el.textContent = 'Erro: ' + (e.message || e.error || 'desconhecido');
    });

    const TARGET_FILE = "target.mind";
    const MODEL_FILE  = "models/projeto.glb";  // confirme o nome e pasta
    const START_SCALE = 0.001;
    const START_Y     = 0.0;

    const info = t => document.getElementById('info').textContent = t;

    let model = null, grid = null, mindarThree = null, renderer = null, scene = null, camera = null, anchor = null;

    // Botão de início para garantir permissão de câmera no iOS
    document.getElementById('startBtn').addEventListener('click', async ()=>{
      document.getElementById('gate').style.display = 'none';
      try {
        await startAR();
      } catch (err) {
        info('Falha ao iniciar câmera: ' + err);
      }
    });

    async function startAR(){
      mindarThree = new window.MINDAR.IMAGE.MindARThree({
        container: document.body,
        imageTargetSrc: TARGET_FILE,
        maxTrack: 1
      });
      renderer = mindarThree.renderer;
      scene = mindarThree.scene;
      camera = mindarThree.camera;

      // Luz
      scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.0));
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      renderer.outputColorSpace = THREE.SRGBColorSpace;

      // Anchor
      anchor = mindarThree.addAnchor(0);

      // Grade opcional 10 cm
      grid = new THREE.GridHelper(0.3, 3);
      grid.rotation.x = Math.PI/2;
      grid.visible = false;
      anchor.group.add(grid);

      // Carrega GLB
      const loader = new THREE.GLTFLoader();
      loader.load(MODEL_FILE, (gltf)=>{
        model = gltf.scene;
        model.scale.setScalar(START_SCALE);
        model.position.set(0, START_Y, 0);
        anchor.group.add(model);
        info('Aponte a câmera para o alvo impresso.');
      }, undefined, (err)=>{
        info('Falha ao carregar o GLB ('+MODEL_FILE+'). Verifique caminho e tamanho.');
        console.error(err);
      });

      await mindarThree.start(); // pede permissão da câmera aqui
      renderer.setAnimationLoop(()=>renderer.render(scene, camera));
    }

    // Controles
    function adjustScale(f){ if(!model) return; const s=model.scale.x*f; model.scale.setScalar(s); info(`Escala: ${s.toFixed(6)} | Altura: ${model.position.y.toFixed(3)} m`); }
    function adjustY(d){ if(!model) return; model.position.y+=d; info(`Escala: ${model.scale.x.toFixed(6)} | Altura: ${model.position.y.toFixed(3)} m`); }
    document.getElementById('bScaleDown').onclick = ()=>adjustScale(0.90);
    document.getElementById('bScaleUp').onclick   = ()=>adjustScale(1.10);
    document.getElementById('bYDown').onclick     = ()=>adjustY(-0.01);
    document.getElementById('bYUp').onclick       = ()=>adjustY(0.01);
    document.getElementById('bGrid').onclick      = ()=>{ if(grid) grid.visible = !grid.visible; };
  </script>
</body>
</html>
